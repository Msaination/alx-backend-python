#!/bin/bash

# kubctl-0x03.sh
# Objective: Perform a rolling update of the Django app to version 2.0 without downtime.

DEPLOYMENT_NAME="messaging-app-blue"
SERVICE_NAME="messaging-app-service"
NAMESPACE="default"

echo "üöÄ Applying updated deployment (image v2.0)..."
kubectl apply -f blue_deployment.yaml -n $NAMESPACE

echo "üîç Monitoring rollout status..."
kubectl rollout status deployment/$DEPLOYMENT_NAME -n $NAMESPACE

# Get ClusterIP and port of the service
CLUSTER_IP=$(kubectl get svc $SERVICE_NAME -n $NAMESPACE -o jsonpath='{.spec.clusterIP}')
PORT=$(kubectl get svc $SERVICE_NAME -n $NAMESPACE -o jsonpath='{.spec.ports[0].port}')

echo "‚ö° Testing app availability with curl (continuous requests)..."
for i in {1..20}; do
  curl -s http://$CLUSTER_IP:$PORT/ | head -n 1
  sleep 2
done

echo "üìã Verifying pods after rollout..."
kubectl get pods -l app=messaging-app,version=blue -n $NAMESPACE -o wide
